---
title: "Take Home Exercise 3"
author: "Rydia"
date: "May 13, 2024"
date-modified: "last-modified"
execute:
  eval: true
  echo: true
  warning: false
  freeze: true
---

# VAST 2024 Mini Challenge 2

## Mini-Challenge 2: Creating Signatures for Geo-Temporal Patterns

Mini-challenge 2 focuses on analyzing ship movements and shipping records to understand illegal fishing practices. FishEye analysts need help creating visualizations to show patterns of ship movements and identify suspicious behaviors. They also want to understand how the commercial fishing community changed after a company was caught fishing illegally.

The details of the mini challenge can be found [here](https://vast-challenge.github.io/2024/MC2.html).

## Tasks and Questions

FishEye analysts need your help to perform geographic and temporal analysis of the CatchNet data so they can prevent illegal fishing from happening again. Your task is to develop new visual analytics tools and workflows that can be used to discover and understand signatures of different types of behavior. Can you use your tool to visualize a signature of SouthSeafood Express Corp’s illegal behavior? FishEye needs your help to develop a workflow to find other instances of illegal behavior.

1.  FishEye analysts have long wanted to better understand the flow of commercially caught fish through Oceanus’s many ports. But as they were loading data into CatchNet, they discovered they had purchased the wrong port records. They wanted to get the ship off-load records, but they instead got the port-exit records (essentially trucks/trains leaving the port area). Port exit records do not include which vessel that delivered the products. Given this limitation, develop a visualization system to associate vessels with their probable cargos. Which vessels deliver which products and when? What are the seasonal trends and anomalies in the port exit records?

2.  Develop visualizations that illustrate the inappropriate behavior of SouthSeafood Express Corp vessels. How do their movement and catch contents compare to other fishing vessels? When and where did SouthSeafood Express Corp vessels perform their illegal fishing? How many different types of suspicious behaviors are observed? Use visual evidence to justify your conclusions.

3.  To support further Fisheye investigations, develop visual analytics workflows that allow you to discover other vessels engaging in behaviors similar to SouthSeafood Express Corp’s illegal activities? Provide visual evidence of the similarities.

4.  How did fishing activity change after SouthSeafood Express Corp was caught? What new behaviors in the Oceanus commercial fishing community are most suspicious and why?

## 1.0 Data Preparation

## 1.1 Loading R Packages

```{r}
pacman::p_load(tidyverse, jsonlite, DT, lubridate,
               igraph, tidygraph, ggraph, 
               visNetwork, sf)
```

## 1.2 Loading the Data

Loading the .json data using `jsonlite` package.

```{r}
mc2_data <- fromJSON("data/MC2/mc2.json")
```

mc2 is a directed multigraph, consists of nodes dataframe and links dataframe.

```{r}
oceanus_map <- read_sf("data/MC2/Oceanus Information/Oceanus Geography.geojson")
```

Loading the oceanus map:

```{r}
ggplot(oceanus_map) +
  geom_sf(color = "black",
          ) +
  theme_void() +
  geom_sf_text(aes(label = Name), size = 2,
               vjust = 1.5)
```

## 1.3 Extracting the tibbles for nodes and links

```{r}
mc2_nodes_raw <- as_tibble(mc2_data$nodes)
```

```{r}
mc2_edges_raw <- as_tibble(mc2_data$links)
```

## 1.4 Checking for missing values in data

```{r}
colSums(is.na(mc2_nodes_raw))
```

```{r}
colSums(is.na(mc2_edges_raw))
```

## 1.5 Parsing the time with lubridate

As the `_date_added` and `_last_edited_date` contains a mixture of format, we first extract the date in "yyyy-mm-dd" format using `substr`.

```{r}
mc2_nodes_raw <- mc2_nodes_raw |> 
  mutate(`_date_added` = substr(`_date_added`,1,10)) |> 
  mutate(`_date_added` = ymd(`_date_added`)) |> 
  mutate(`_last_edited_date` = substr(`_last_edited_date`,1,10)) |> 
  mutate(`_last_edited_date` = ymd(`_last_edited_date`)) |> 
  mutate(date = ymd(date))
```

```{r}

mc2_edges_raw <- mc2_edges_raw %>% 
  mutate(`_date_added` = substr(`_date_added`,1,10)) %>% 
  mutate(`_date_added` = ymd(`_date_added`)) %>% 
  mutate(`_last_edited_date`= substr(`_last_edited_date`,1,10)) %>% 
  mutate(`_last_edited_date` = ymd(`_last_edited_date`)) %>% 
  mutate(time = ymd_hms(time))
    
```

**Understanding the Data**

```{r}
unique_nodes_type <- mc2_nodes_raw |>  distinct(type)
unique_nodes_type
```

```{r}
unique_edges_type <- mc2_edges_raw |>  distinct(type)
unique_edges_type
```

## 1.6 Aggregating weight for edges

To get aggregated weight for the edges by unique source, target and type.

```{r}
mc2_edges_agg <-
  mc2_edges_raw %>%
  distinct() %>%
  mutate(source = as.character(source),
         target = as.character(target),
         type = as.character(type)) %>%
  group_by(source, target, type) %>%
  summarise(weights = n()) %>%
  filter(source!=target) 
  ungroup
```

## 2.0 Task 1

## 2.1 Flow of fishing vessels

FishEye analysts have long wanted to better understand the flow of commercially caught fish through Oceanus’s many ports.

```{r}
transaction_edges <- mc2_edges_raw %>% 
  filter(type == "Event.Transaction")
```

```{r}
transaction_edges_agg <-
  transaction_edges  %>%
  distinct() %>%
  group_by(source, target, type) %>%
  summarise(weights = n()) %>%
  filter(source!=target) %>% 
  ungroup
```

```{r}
fishing_vessels_nodes <- mc2_nodes_raw %>% 
  filter(type == "Entity.Vessel.FishingVessel")
fishing_vessels_nodes 
```

There is a total of 178 Fishing vessels in Oceanus.

## 2.2 Fishing ground locations

```{r}
fishing_ground <- mc2_nodes_raw %>% 
  filter(kind == "Fishing Ground") 
```

```{r}
non_fishing_ground <- mc2_nodes_raw %>%  
  filter(kind == "Ecological Preserve") 
```

There are three fishing grounds:

1\. Cod Table

2\. Wrasse Beds

3\. Tuna Shelf

Fishing outside these fishing grounds are considered illegal fishing.

```{r}
cargo_vessels <- mc2_nodes_raw %>%  
  filter(type == "Entity.Vessel.CargoVessel") %>% 
  arrange(desc(tonnage))
cargo_vessels
```

There are 100 cargo vessels, with tonnage ranging from 2,100 to 76,300.

## 2.3 The flow of cargo

Finding out which commodity goes to which ports.

```{r}
cargo_port_list <- mc2_edges_raw %>% 
  filter(type == "Event.Transaction") %>% 
  select(source,target) %>% 
  filter(target %in% c("City of Haacklee",
                       "City of Lomark",
                       "City of Himark",
                       "City of Paackland",
                       "City of South Paackland",
                       "City of Port Grove"))

cargo_commodity_list <- mc2_edges_raw %>% 
  filter(type == "Event.Transaction") %>% 
  select(source,target) %>% 
  filter(!target %in% c("City of Haacklee",
                       "City of Lomark",
                       "City of Himark",
                       "City of Paackland",
                       "City of South Paackland",
                       "City of Port Grove")) %>% 
  rename(commodity = target)

cargo_list <- cargo_port_list %>% 
  left_join(cargo_commodity_list) %>%
  left_join(transaction_edges) %>% 
  select(source, target, commodity, date) %>% 
  rename(cargo = source, city = target)

```

```{r}
delivery_nodes <- mc2_nodes_raw %>% 
  filter(type == "Entity.Document.DeliveryReport")
```

Adding quantity (qty_ton) to cargos

```{r}
cargo_list <- delivery_nodes %>% 
  select(id,qty_tons) %>% 
  rename(cargo = id) %>% 
  left_join(cargo_list)
```

```{r}
harbor_report <- mc2_edges_raw %>% 
  filter(type == "Event.HarborReport")
```

```{r}
harbor_report <- mc2_edges_raw %>% 
  filter(type == "Event.HarborReport") %>% 
  select(source, target, date) %>% 
  distinct() %>% 
  rename(city = target, vessel = source)
```

```{r}
cargo_list <- cargo_list %>% 
  left_join(harbor_report) %>% 
  rename(vessel_hr = vessel)
```

```{r}
colSums(is.na(cargo_list))
```

```{r}
fishing_vessel_list <- fishing_vessels_nodes %>% 
  select(id) 

fishing_vessel_list <- as.list(fishing_vessel_list)

transponder_location <- mc2_edges_raw %>% 
  filter(type == "Event.TransportEvent.TransponderPing") %>%
  filter(target %in% unlist(fishing_vessel_list)) %>% 
  select(source, target, time) %>% 
  mutate(time = substr(time,1,10)) %>% 
  mutate(time = ymd(time)) %>%
  distinct() %>% 
  rename(city = source, vessel_tp = target, date = time)
```

```{r}
cargo_list <- cargo_list %>% 
  mutate(date = ymd(date)) %>% 
  left_join(transponder_location)
```

```{r}
transponder_ping_edge <- mc2_edges_raw %>% 
  filter(type == "Event.TransportEvent.TransponderPing")
```

Finding the vessel that enters the city same day as the cargo

```{r}
fishing_vessel_list <- fishing_vessels_nodes %>% 
  select(id) 

fishing_vessel_list <- as.list(fishing_vessel_list)

vessel_city_list <- transponder_ping_edge %>% 
  filter(target %in% unlist(fishing_vessel_list)) %>% 
  filter(source %in% c("City of Haacklee",
                       "City of Lomark",
                       "City of Himark",
                       "City of Paackland",
                       "City of South Paackland",
                       "City of Port Grove")) %>% 
  filter(dwell > 0) %>% 
  mutate(time = substr(time,1,10)) %>% 
  mutate(time = ymd(`_date_added`)) %>% 
  select(source, target, time) %>% 
  distinct() %>% 
  rename(date = time, target = source, id = target)

```

## 3.0 Task 2

Develop visualizations that illustrate the inappropriate behavior of SouthSeafood Express Corp vessels. How do their movement and catch contents compare to other fishing vessels? When and where did SouthSeafood Express Corp vessels perform their illegal fishing? How many different types of suspicious behaviors are observed? Use visual evidence to justify your conclusions.

## 3.1 Illegal fishing by SouthSeafood Express Corp

SouthSeafood Express Corp operates two fishing vessels by the id of "snappersnatcher7be" and "roachrobberdb6".

```{r}
transponder_ping_edge_agg <-
  transponder_ping_edge %>%
  distinct() %>%
  group_by(source, target, type) %>%
  summarise(weights = n()) %>%
  filter(source!=target) %>% 
  ungroup
```

```{r}
transponder_ping_edge_agg %>% 
  filter(target %in% c("snappersnatcher7be","roachrobberdb6")) %>%
  group_by(target) %>% 
  ggplot(aes(x=target, y=source,
             size = weights)) +
  geom_point()

```

```{r}
southseafood_edge <- mc2_edges_raw %>% 
  filter(type == "Event.TransportEvent.TransponderPing") %>% 
  filter(target %in% c("snappersnatcher7be","roachrobberdb6")) %>% 
  arrange(target,time)
```

```{r}
ssf_edges_agg <-
  southseafood_edge %>%
  distinct() %>%
  group_by(source, target, type) %>%
  summarise(weights = n()) %>%
  filter(source!=target) %>% 
  ungroup
```

```{R}
id1 <- ssf_edges_agg %>% 
  select(source) %>% 
  rename(id = source) 

id2 <- ssf_edges_agg %>% 
  select(target) %>% 
  rename(id = target)

mc2_nodes1 <- rbind(id1,id2) %>% 
  distinct() 
```

```{r}
ssf_graph <- tbl_graph(nodes = mc2_nodes1,
                       edges = ssf_edges_agg,
                       directed = TRUE)
```

```{r}
# Add a color column to nodes
ssf_graph <- ssf_graph %>%
  activate(nodes) %>%
  mutate(color = case_when(
    id %in% c("snappersnatcher7be", "roachrobberdb6") ~ "blue",
    TRUE ~ ""
  ))

# Create the plot
ssf_graph %>% 
  activate(edges) %>%
  arrange(desc(weights)) %>% 
  ggraph(layout = "fr") +
  geom_edge_link(aes(color = "", 
                     linewidth = weights)) +
  geom_node_point(aes(color = color, size = 10)) + 
  theme_graph() +
  theme(
    plot.background = element_rect(fill = "white", color = NA),
    text = element_text(color = "black"))+
  geom_node_text(aes(label = id), 
                 repel = TRUE, 
                 vjust = 1, 
                 hjust = 1,
                 size = 3)
```

## 4.0 Task 4

**The Questions**:

1.  How did fishing activity change after SouthSeafood Express Corp was caught?

2.  What new behaviors in the Oceanus commercial fishing community are most suspicious and why?

In order to understand the change in fishing activities, we first have to determine the date where SouthSeafood Express Corp was caught. We will use this timeline as the

The final activities of SouthSeafood's vessels are on 2035-05-16 (snappersnatcher7be) and 2035-05-16 (roachrobberdb6) according to the transponder pings. Hence, we can conclude that the SouthSeafood is caught for illegal fishing, and had ceased operating its fishing vessels since 2035-05-16.
